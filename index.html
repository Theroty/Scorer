<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Tournament Manager (jQuery)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Theme-agnostic styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .shuttle-spin {
            animation: spin 3s linear infinite;
        }
        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Theme-specific styles (dynamically applied by JS) */
        .glass-panel-dark {
            background: rgba(30, 41, 59, 0.7); /* slate-800 */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-panel-light {
            background: rgba(255, 255, 255, 0.8); /* white */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- The entire application UI will be rendered here by jQuery -->
    </div>

     <!-- FOOTER ELEMENT - Content and styling updated by JS -->
    <footer id="app-footer" class="py-4 text-center text-sm mt-8"></footer>

    <script>
        // --- GLOBAL STATE ---
        let theme = localStorage.getItem('theme') || 'dark';
        let players = ["Sarathi", "Deepak", "Pradeep", "Mohan", "Charlesh", "Nadraj"];
        let matches = [];
        let tournamentStarted = false;
        let matchIdCounter = 1;

        // --- THEME UTILITIES ---
        const getThemeClass = (darkClass, lightClass) => theme === 'dark' ? darkClass : lightClass;
        const getPrimaryColorClass = (base) => theme === 'dark' ? `text-green-${base}` : `text-blue-${base}`;
        const getPrimaryBgClass = (base) => theme === 'dark' ? `bg-green-${base}` : `bg-blue-${base}`;
        const getPrimaryHoverClass = (base) => theme === 'dark' ? `hover:bg-green-${base}` : `hover:bg-blue-${base}`;
        const getPrimaryRingClass = () => theme === 'dark' ? `ring-green-500/50` : `ring-blue-500/50`;
        const getPanelClass = () => theme === 'dark' ? 'glass-panel-dark' : 'glass-panel-light';
        const getTextMutedClass = () => theme === 'dark' ? 'text-slate-400' : 'text-gray-600';
        const getInputBorderClass = () => theme === 'dark' ? 'border-slate-600' : 'border-gray-300';
        const getInputBgClass = () => theme === 'dark' ? 'bg-slate-900' : 'bg-white';
        const getTextPanelClass = () => theme === 'dark' ? 'text-white' : 'text-gray-900';
        const getPanelHeaderBgClass = () => theme === 'dark' ? 'bg-slate-700' : 'bg-gray-200';
        const getTableBorderClass = () => theme === 'dark' ? 'border-slate-700/50' : 'border-gray-300';

        // --- CORE LOGIC FUNCTIONS ---

        function addPlayer() {
            const newPlayerName = $('#new-player-name').val().trim();
            if (newPlayerName && !players.includes(newPlayerName)) {
                players.push(newPlayerName);
                $('#new-player-name').val('');
                // Only render the players card, which will re-attach its listeners
                renderPlayers(); 
            }
        }

        function removePlayer(name) {
            players = players.filter(p => p !== name);
            // Only render the players card, which will re-attach its listeners
            renderPlayers();
        }

        function shufflePlayers() {
            players.sort(() => Math.random() - 0.5);
            // Only render the players card, which will re-attach its listeners
            renderPlayers();
        }

        function generateSchedule() {
            if (players.length < 4) {
                console.log("Need at least 4 players for doubles."); 
                return;
            }

            matches = [];
            matchIdCounter = 1;

            let allPairs = [];
            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    allPairs.push([players[i], players[j]]);
                }
            }

            allPairs.sort(() => Math.random() - 0.5);

            allPairs.forEach((pair1) => {
                const p1 = pair1[0];
                const p2 = pair1[1];
                const availableOpponents = players.filter(p => p !== p1 && p !== p2);
                
                // Simple opponent assignment: just take the first two available
                const shuffledOpp = availableOpponents.sort(() => Math.random() - 0.5);
                const opp1 = shuffledOpp[0];
                const opp2 = shuffledOpp[1];

                // Ensure we have 4 players before adding a match
                if (opp1 && opp2) {
                    matches.push({
                        id: matchIdCounter++,
                        t1: [p1, p2],
                        t2: [opp1, opp2],
                        score1: 0,
                        score2: 0,
                        played: false,
                        type: "Normal"
                    });
                }
            });

            tournamentStarted = true;
            renderAll();
        }

        function updateScore(id, field, value) {
            const matchIndex = matches.findIndex(m => m.id === id);
            if (matchIndex !== -1) {
                const val = parseInt(value) || 0;
                matches[matchIndex][field] = val;
                
                // Mark as played if a score is recorded
                if (matches[matchIndex].score1 > 0 || matches[matchIndex].score2 > 0) {
                    matches[matchIndex].played = true;
                } else {
                    matches[matchIndex].played = false;
                }

                renderLeaderboard();
                renderSchedule();
            }
        }

        function updateType(id, val) {
            const matchIndex = matches.findIndex(m => m.id === id);
            if (matchIndex !== -1) {
                matches[matchIndex].type = val;
                renderSchedule();
            }
        }
        
        function calculateLeaderboard() {
            const stats = {};
            
            players.forEach(p => {
                stats[p] = { name: p, played: 0, wins: 0, losses: 0, diff: 0, points: 0 };
            });

            matches.forEach(m => {
                if (m.played) {
                    const team1 = m.t1;
                    const team2 = m.t2;
                    const s1 = m.score1;
                    const s2 = m.score2;
                    const diff = s1 - s2;

                    team1.forEach(p => {
                        if(stats[p]) {
                            stats[p].played += 1;
                            stats[p].diff += diff;
                            if (s1 > s2) { stats[p].wins += 1; stats[p].points += 2; }
                            else if (s1 === s2) { stats[p].points += 1; }
                            else { stats[p].losses += 1; }
                        }
                    });

                    team2.forEach(p => {
                        if(stats[p]) {
                            stats[p].played += 1;
                            stats[p].diff -= diff;
                            if (s2 > s1) { stats[p].wins += 1; stats[p].points += 2; }
                            else if (s1 === s2) { stats[p].points += 1; }
                            else { stats[p].losses += 1; }
                        }
                    });
                }
            });

            return Object.values(stats).sort((a, b) => b.points - a.points || b.diff - a.diff);
        }
        
        function exportToCSV() {
            const leaderboardData = calculateLeaderboard();
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Section 1: Leaderboard
            csvContent += "LEADERBOARD\n";
            csvContent += "Rank,Player,Matches Played,Wins,Losses,Score Diff,Points\n";
            leaderboardData.forEach((p, index) => {
                csvContent += `${index + 1},${p.name},${p.played},${p.wins},${p.losses},${p.diff},${p.points}\n`;
            });

            csvContent += "\nMATCH SCHEDULE\n";
            csvContent += "Match ID,Team 1 P1,Team 1 P2,Team 2 P1,Team 2 P2,Score T1,Score T2,Playing Type\n";
            matches.forEach(m => {
                csvContent += `${m.id},${m.t1[0]},${m.t1[1]},${m.t2[0]},${m.t2[1]},${m.score1},${m.score2},${m.type}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "badminton_tournament.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- RENDERING FUNCTIONS ---

        function renderThemeToggle() {
            return `
                <div class="w-full flex justify-end">
                    <button 
                        id="theme-toggle"
                        class="p-2 rounded-full transition ${getThemeClass('bg-slate-800 hover:bg-slate-700 text-slate-300', 'bg-gray-200 hover:bg-gray-300 text-gray-600')}"
                        title="${theme === 'dark' ? 'Switch to Day Mode' : 'Switch to Night Mode'}"
                    >
                        <i class="fa-solid ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}"></i>
                    </button>
                </div>
            `;
        }
        
        // Helper to attach listeners specific to the Player Card, called after every re-render of this card.
        function attachPlayerCardListeners() {
            // Player Management
            $('#add-player-btn').off('click').on('click', addPlayer);
            $('#new-player-name').off('keypress').on('keypress', function(e) {
                if (e.key === 'Enter') addPlayer();
            });
            // Delegated click handler for dynamically created remove buttons
            $('#players-card').off('click', '.remove-player-btn').on('click', '.remove-player-btn', function() {
                const name = $(this).data('player-name');
                removePlayer(name);
            });
            $('#shuffle-players-btn').off('click').on('click', shufflePlayers);
            
            // Tournament Start/Reset
            $('#start-tournament-btn').off('click').on('click', generateSchedule);
            $('#reset-tournament-btn').off('click').on('click', function() {
                if(confirm("Reset tournament? All scores will be lost.")) {
                    tournamentStarted = false;
                    matches = [];
                    renderAll();
                }
            });
        }


        function renderPlayers() {
            const playerListHtml = players.map((p, idx) => `
                <div class="group relative ${getPanelHeaderBgClass()} ${getThemeClass('hover:bg-slate-600', 'hover:bg-gray-300')} px-3 py-1 rounded-full text-sm flex items-center transition cursor-default">
                    ${p}
                    ${!tournamentStarted ? `<button data-player-name="${p}" class="remove-player-btn ml-2 text-red-400 hover:text-red-300"><i class="fa-solid fa-times"></i></button>` : ''}
                </div>
            `).join('');

            const playerCardHtml = `
                <div class="${getPanelClass()} rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold ${getTextPanelClass()}"><i class="fa-solid fa-users mr-2"></i> Players</h2>
                        <span class="${getPanelHeaderBgClass()} px-2 py-1 rounded text-xs ${getTextMutedClass()}">${players.length} Players</span>
                    </div>
                    
                    ${!tournamentStarted ? `
                        <div class="flex gap-2 mb-4">
                            <input 
                                id="new-player-name"
                                type="text" 
                                class="w-full ${getInputBgClass()} ${getInputBorderClass()} rounded px-3 py-2 ${getTextPanelClass()} focus:outline-none ${getThemeClass('focus:border-green-500', 'focus:border-blue-500')}"
                                placeholder="Add player..."
                                value=""
                            />
                            <button id="add-player-btn" class="${getPrimaryBgClass(600)} ${getPrimaryHoverClass(700)} text-white px-4 rounded transition">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    ` : ''}

                    <div id="player-list-container" class="flex flex-wrap gap-2 mb-4">
                        ${playerListHtml}
                    </div>

                    ${!tournamentStarted ? `
                        <div class="flex gap-2">
                            <button id="shuffle-players-btn" class="flex-1 ${getThemeClass('bg-slate-600 hover:bg-slate-500', 'bg-gray-400 hover:bg-gray-500')} py-2 rounded text-white font-semibold transition">
                                <i class="fa-solid fa-shuffle mr-2"></i> Shuffle
                            </button>
                            <button id="start-tournament-btn" class="flex-1 ${getPrimaryBgClass(600)} ${getPrimaryHoverClass(500)} py-2 rounded text-white font-semibold transition">
                                Start <i class="fa-solid fa-play ml-2"></i>
                            </button>
                        </div>
                    ` : `
                        <button id="reset-tournament-btn" class="w-full bg-red-900/50 hover:bg-red-900 text-red-200 py-2 rounded border border-red-800 transition">
                            Reset Tournament
                        </button>
                    `}
                </div>
            `;
            $('#players-card').html(playerCardHtml);
            
            // FIX: Re-attach event listeners specific to the player card immediately after rendering
            attachPlayerCardListeners();
        }

        function renderLeaderboard() {
            const leaderboardData = calculateLeaderboard();
            let leaderboardHtml = '';

            if (tournamentStarted) {
                const rows = leaderboardData.map((p, i) => `
                    <tr class="border-b ${getTableBorderClass()} ${getThemeClass('hover:bg-slate-700/30', 'hover:bg-gray-200/50')} transition">
                        <td class="py-2 font-medium">
                            ${i===0 ? `<i class="fa-solid fa-crown mr-1 ${theme === 'dark' ? 'text-yellow-500' : 'text-yellow-600'}"></i>` : ''}
                            ${p.name}
                        </td>
                        <td class="py-2 text-center ${getTextMutedClass()}">${p.played}</td>
                        <td class="py-2 text-center ${getPrimaryColorClass(400)}">${p.wins}</td>
                        <td class="py-2 text-center ${p.diff > 0 ? getPrimaryColorClass(400) : 'text-red-400'}">${p.diff > 0 ? `+${p.diff}` : p.diff}</td>
                        <td class="py-2 text-right font-bold ${getTextPanelClass()}">${p.points}</td>
                    </tr>
                `).join('');

                leaderboardHtml = `
                    <div class="${getPanelClass()} rounded-xl p-6 shadow-lg border-t-4 ${theme === 'dark' ? 'border-t-yellow-500' : 'border-t-yellow-600'}">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold ${getTextPanelClass()}"><i class="fa-solid fa-trophy mr-2 ${theme === 'dark' ? 'text-yellow-400' : 'text-yellow-600'}"></i> Standings</h2>
                            <button id="export-csv-btn" class="text-xs ${getPrimaryBgClass(800)} ${getPrimaryHoverClass(700)} ${getPrimaryColorClass(100)} px-2 py-1 rounded">
                                <i class="fa-solid fa-file-excel mr-1"></i> Export Excel
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="${getTextMutedClass()} border-b ${getInputBorderClass()}">
                                    <tr>
                                        <th class="py-2">Player</th>
                                        <th class="py-2 text-center">P</th>
                                        <th class="py-2 text-center">W</th>
                                        <th class="py-2 text-center">Diff</th>
                                        <th class="py-2 text-right">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            $('#leaderboard-card').html(leaderboardHtml);
        }

        function renderSchedule() {
            let scheduleContentHtml = '';

            if (!tournamentStarted) {
                scheduleContentHtml = `
                    <div class="flex flex-col items-center justify-center h-64 ${getTextMutedClass()} border-2 border-dashed ${getThemeClass('border-slate-700', 'border-gray-300')} rounded-xl">
                        <i class="fa-solid fa-clipboard-list text-4xl mb-4"></i>
                        <p>Add players and click Start to generate fixtures.</p>
                    </div>
                `;
            } else {
                const matchesHtml = matches.map(match => {
                    const t1Class = match.score1 > match.score2 && match.played ? `${getPrimaryBgClass(900)}/20 ring-1 ${getPrimaryRingClass()}` : '';
                    const t2Class = match.score2 > match.score1 && match.played ? `${getPrimaryBgClass(900)}/20 ring-1 ${getPrimaryRingClass()}` : '';
                    const matchBgClass = match.played 
                        ? getThemeClass('bg-slate-800/80 border-slate-600', 'bg-gray-100/90 border-gray-300')
                        : getThemeClass('bg-slate-800/40 border-slate-700', 'bg-white/70 border-gray-300');

                    return `
                        <div class="relative rounded-lg p-4 transition-all duration-200 border ${matchBgClass}">
                            <div class="absolute top-2 left-3 text-xs text-slate-500 font-mono">Match #${match.id}</div>
                            
                            <div class="flex flex-col md:flex-row items-center justify-between gap-4 mt-4">
                                
                                <!-- Team 1 -->
                                <div class="flex-1 flex flex-col items-center p-2 rounded ${t1Class}">
                                    <div class="flex gap-2 mb-2 font-semibold text-lg ${getTextPanelClass()}">
                                        <span>${match.t1[0]}</span> & <span>${match.t1[1]}</span>
                                    </div>
                                    <input 
                                        type="number" 
                                        data-match-id="${match.id}" 
                                        data-field="score1"
                                        value="${match.score1}" 
                                        min="0"
                                        class="score-input ${getThemeClass('bg-slate-900', 'bg-gray-200')} text-center text-2xl font-bold w-20 py-1 rounded border ${getInputBorderClass()} ${getTextPanelClass()} focus:outline-none ${getThemeClass('focus:border-green-500', 'focus:border-blue-500')}"
                                    />
                                </div>

                                <!-- VS Badge -->
                                <div class="font-bold text-xl px-2 ${getTextMutedClass()}">VS</div>

                                <!-- Team 2 -->
                                <div class="flex-1 flex flex-col items-center p-2 rounded ${t2Class}">
                                    <div class="flex gap-2 mb-2 font-semibold text-lg ${getTextPanelClass()}">
                                        <span>${match.t2[0]}</span> & <span>${match.t2[1]}</span>
                                    </div>
                                    <input 
                                        type="number" 
                                        data-match-id="${match.id}" 
                                        data-field="score2"
                                        value="${match.score2}" 
                                        min="0"
                                        class="score-input ${getThemeClass('bg-slate-900', 'bg-gray-200')} text-center text-2xl font-bold w-20 py-1 rounded border ${getInputBorderClass()} ${getTextPanelClass()} focus:outline-none ${getThemeClass('focus:border-green-500', 'focus:border-blue-500')}"
                                    />
                                </div>
                            </div>

                            <!-- Meta Data -->
                            <div class="mt-4 pt-3 border-t ${getThemeClass('border-slate-700', 'border-gray-300')} flex items-center gap-2">
                                <span class="text-xs ${getTextMutedClass()} uppercase tracking-wider">Play Type:</span>
                                <select 
                                    data-match-id="${match.id}"
                                    class="type-select ${getThemeClass('bg-slate-900 text-slate-300 border-slate-600', 'bg-gray-200 text-gray-800 border-gray-300')} text-xs rounded px-2 py-1 focus:outline-none"
                                >
                                    <option value="Normal" ${match.type === 'Normal' ? 'selected' : ''}>Normal</option>
                                    <option value="Smash Heavy" ${match.type === 'Smash Heavy' ? 'selected' : ''}>Smash Heavy</option>
                                    <option value="Drop Game" ${match.type === 'Drop Game' ? 'selected' : ''}>Drop Game</option>
                                    <option value="Rally" ${match.type === 'Rally' ? 'selected' : ''}>Long Rally</option>
                                    <option value="Net Play" ${match.type === 'Net Play' ? 'selected' : ''}>Net Play</option>
                                </select>
                                
                                ${match.played ? `<span class="ml-auto text-xs ${getTextMutedClass()}">Diff: ${Math.abs(match.score1 - match.score2)}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                scheduleContentHtml = `<div class="grid gap-4">${matchesHtml}</div>`;
            }

            const scheduleCardHtml = `
                <div class="${getPanelClass()} rounded-xl p-6 shadow-lg min-h-[600px]">
                    <h2 class="text-xl font-bold ${getTextPanelClass()} mb-6 flex items-center">
                        <i class="fa-regular fa-calendar-check mr-2"></i> 
                        Match Schedule
                        ${tournamentStarted ? `<span class="ml-3 text-sm font-normal ${getTextMutedClass()}">(${matches.length} Matches Generated)</span>` : ''}
                    </h2>
                    <div id="schedule-content">
                        ${scheduleContentHtml}
                    </div>
                </div>
            `;
            $('#schedule-card').html(scheduleCardHtml);
        }

        function renderAll() {
            // Apply body theme
            $('body').removeClass('bg-slate-900 text-slate-200 bg-gray-100 text-gray-900');
            $('body').addClass(getThemeClass('bg-slate-900 text-slate-200', 'bg-gray-100 text-gray-900'));

            // Construct the main container content
            const appHtml = `
                ${renderThemeToggle()}

                <!-- Header -->
                <div class="text-center mb-8 flex flex-col items-center">
                    <h1 class="text-4xl md:text-5xl font-bold ${getPrimaryColorClass(400)} mb-2 -mt-10">
                        <i class="fa-solid fa-feather-pointed mr-3 shuttle-spin"></i>
                        Shuttle Master
                    </h1>
                    <p class="${getTextMutedClass()}">Tournament Scheduler & Scorer</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <!-- LEFT COLUMN: Setup & Leaderboard -->
                    <div class="lg:col-span-4 space-y-6">
                        <div id="players-card"></div>
                        <div id="leaderboard-card"></div>
                    </div>

                    <!-- RIGHT COLUMN: Schedule -->
                    <div class="lg:col-span-8">
                        <div id="schedule-card"></div>
                    </div>
                </div>
            `;
            $('#app-container').html(appHtml);

            // Render sub-components (these calls will re-attach their specific listeners)
            renderPlayers();
            renderLeaderboard();
            renderSchedule();

            // Attach listeners that don't need re-attaching on card updates (Theme, Score/Type, Export)
            attachGlobalListeners();
        }

        // --- EVENT LISTENERS ---

        function attachGlobalListeners() {
            // Theme Toggle
            $('#theme-toggle').off('click').on('click', () => {
                theme = theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', theme);
                renderAll();
            });

            // Score and Type Updates (Delegated events on the main schedule container)
            $('#schedule-card').off('input', '.score-input').on('input', '.score-input', function() {
                const id = parseInt($(this).data('match-id'));
                const field = $(this).data('field');
                const value = $(this).val();
                updateScore(id, field, value);
            });

            $('#schedule-card').off('change', '.type-select').on('change', '.type-select', function() {
                const id = parseInt($(this).data('match-id'));
                const value = $(this).val();
                updateType(id, value);
            });
            
            // CSV Export (Delegated event on the leaderboard container)
            $('#leaderboard-card').off('click', '#export-csv-btn').on('click', '#export-csv-btn', exportToCSV);
        }


        // --- SECURITY / DEV TOOLS PROTECTION ---
        function attachSecurityListeners() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            // Disable keyboard shortcuts for DevTools (F12, Ctrl+Shift+I, Ctrl+U)
            document.addEventListener('keydown', (e) => {
                // F12
                if (e.keyCode === 123) {
                    e.preventDefault();
                }
                // Ctrl+Shift+I (Inspect) or Ctrl+Shift+J (Console) or Ctrl+Shift+C
                if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C' || e.key === 'i' || e.key === 'j' || e.key === 'c')) {
                    e.preventDefault();
                }
                // Ctrl+U (View Source)
                if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) {
                    e.preventDefault();
                }
            });
        }

        // --- INITIALIZATION ---
        $(document).ready(function() {
            attachSecurityListeners();
            renderAll();
        });

    </script>
</body>
</html>
